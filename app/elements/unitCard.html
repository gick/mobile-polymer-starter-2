<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="unit-card">
  <style>

    paper-card {
    }


    paper-card {
      width: 100%;
      height:90%;
      margin : 0 auto;
      margin-top:90px;
      margin-bottom:90px;
      display:block;

      --paper-card-header:{ background-color: #b2ffa6;}    }


    paper-button.red {
      background-color: var(--paper-red-500);
      color: white;
    }



    .header.paper-card{

 }

    paper-button.green {
      background-color: var(--paper-green-500);
      color: white;
    }

    .disabled{
      opacity:0.2;
      pointer-events: none;
      cursor: default;
    }

    .done{
      opacity:0.7;
      background-color: greenyellow;
      pointer-events: none;
      cursor: default;

    }

  </style>
  <template>
    <iron-ajax auto url="example.json" handle-as="json" last-response="{{items}}"></iron-ajax>
    <template    id="mainRepeat" is="dom-repeat" items="{{items}}" as="item">
      <fullscreen-api  class="fsapi"></fullscreen-api>
      <paper-card style="--paper-card-header:{ background-color: #a7ff97;}"class$="[[item.class ]]"   heading="[[item.activityName]]" >
      <div style="min-height:200px;height:70%" class="card-content">
        <template is="dom-if" if="{{item.started}}">
         <div hidden$="[[item.completed]]">
          <mcq-activity   mcq="{{item.mcq}}" id="mcq"></mcq-activity>

          <template is="dom-if" if="[[item.indice.isBasic]]">
            <basic-indice indice="[[item.indice]]"></basic-indice>
          </template>
          <template is="dom-if" if="[[item.indice.isGmap]]">
            <gmap-activity id="map"></gmap-activity>
          </template>
           <template is="dom-if" if="[[item.indice.isRadar]]">
             <radar-anim distance={{distance}} long=Ë‡{{longitude}} frequency="{{freq}}"></radar-anim>
           </template>


         </div>

        </template>

        <template is="dom-if" if="{{item.completed}}">
          You learn this today
        </template>

      </div>

        <div hidden$="[[item.completed]]" class="card-actions" style="position: absolute;width: 100%;bottom: 10px;">

        <paper-button id="Start" raised class="green" on-click="start">Start</paper-button>
        <paper-button on-click="nextActivity" class="red" raised id="cancel" >Dismiss</paper-button>
        <paper-button type="button" style="float:right;margin-right: 30px;" on-click="goFullscreen" hidden$="[[!fullscreenAvailable]]">Show full screen</paper-button>


      </div>
    </paper-card>
  </template>
</template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'unit-card',
        showMCQ:function(item){
          var dialog = Polymer.dom(this.root).querySelectorAll("mcq-activity");


            dialog[item.model.__data__.index].open(item.model.__data__.index);



        },
        ready:function(){
          this.freq=1500;
          this.addEventListener('radar-update',this.distChanged);
          this.addEventListener('spActivityComplete', this.next);
          this.addEventListener('eventFromIndiceChild', this.indiceCompleted);

        },
        indiceCompleted:function(e){
          var dialog = Polymer.dom(this.root).querySelector("mcq-activity");
          dialog.open();
        },
        distChanged:function(d){
          console.log(d);
        },
        animateRadar:function(){
          this.freq-=100;
        Polymer.dom(this.root).querySelector("radar-anim").animate();
      }
        ,
        goFullscreen:function(e) {
         var index =e.model.index+1;
          var fsapi = Polymer.dom(this.root).querySelector(".fsapi");
          fsapi.setAttribute('target','paper-card:nth-of-type('+index+')');
        fsapi.toggleFullscreen();
      }

        ,
        next:function(item){
          var i;
          for (i in this.items){
            if(i.started==true){
            var current=this.items.indexOf(i)
            }
          }
          console.log(i)
          this.notifyPath('items.'+current+'.started',"false")
          this.notifyPath('items.'+current+'.class',"done")
          this.notifyPath('items.'+current+'.completed',"true")


          var fsapi = Polymer.dom(this.root).querySelector(".fsapi");
          fsapi.exitFullscreen();
        //  this.nextActivity("sp",i)


        },
        computeClass:function(item){
          console.log(item)
          if(item.current) return "";
          else return "disabled"
        },
        showItem:function(a,b){
          console.log(a)
          console.log(b)
          console.log(a && b)
          return a && b;
        },
        myAction:function(e,f){
          console.log(e.detail)
          console.log(f)
          alert('mcqcomplete')
        },
        start:function(e){
          console.log(e);
        var model= e.model;


        //  this.items[e.model.index].started=!this.items[e.model.index].started;
          model.set('item.started',!this.items[e.model.index].started);


        },

        nextActivity:function(e){
            var model= e.model
            var index= e.model.index+1;
            var str='items.'+index+1+'.class'
          /*  this.items[index].class='current'
            this.items[index -1].class='done'

            this.notifyPath("items."+index+".class",this.items[index].class);
            this.notifyPath("items."+index-1+".class",this.items[index-1].class);
*/      console.log(model)
        model.set("item.class","done")
        model.set("item.completed",true)
          this.set('items.'+index+'.class',"current")
          this.notifyPath(items[index],"current");
          console.log(this.set.items)
        }
        ,

        properties: {
          items:{type : Array, notify:true}
        }
      });
    })();
  </script>
</dom-module>
